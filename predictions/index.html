<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- embed font -->
    <link rel="stylesheet" media="screen" href="https://fontlibrary.org/en/face/terminal-grotesque" type="text/css" />
    <title> KY Weather</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
        body {
            background-color: black;
            color: limegreen;
            font-family: 'TerminalGrotesqueOpenRegular', monospace !important;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 10px limegreen;
        }

        h2 {
            font-size: 1.8em;
            text-align: center;
            margin: 40px 0 20px 0;
            text-shadow: 0 0 8px limegreen;
            border-bottom: 2px solid limegreen;
            padding-bottom: 10px;
        }

        .form-section {
            border: 2px solid limegreen;
            padding: 20px;
            margin-bottom: 30px;
            background-color: rgba(0, 255, 0, 0.05);
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-row2 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-row3 {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 0;
        }

        .button-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: limegreen;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            background-color: black;
            color: limegreen;
            border: 2px solid limegreen;
            font-family: 'TerminalGrotesqueOpenRegular', monospace !important;
            font-size: 0.95em;
        }

        .form-group input:focus {
            outline: none;
            box-shadow: 0 0 10px limegreen;
        }

        .form-group input::placeholder {
            color: #00ff0055;
        }

        button {
            background-color: black;
            color: limegreen;
            border: 2px solid limegreen;
            padding: 8px 20px;
            font-size: 0.95em;
            font-family: 'TerminalGrotesqueOpenRegular', monospace !important;
            cursor: pointer;
            white-space: nowrap;
            width: 100%;
        }

        button:hover {
            background-color: limegreen;
            color: black;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        #error {
            display: none;
            background-color: rgba(255, 0, 0, 0.2);
            color: red;
            border: 2px solid red;
            padding: 15px;
            margin: 20px 0;
        }

        #output {
            margin-top: 30px;
        }

        .plots-container {
            width: 100%;
        }

        .plots-container>div {
            margin-bottom: 30px;
            border: 1px solid limegreen;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .radar-section {
            margin-top: 50px;
            border: 2px solid limegreen;
            padding: 20px;
            background-color: rgba(0, 255, 0, 0.05);
        }

        .radar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .radar-output {
            text-align: center;
            margin-top: 20px;
        }

        .radar-output video {
            max-width: 100%;
            border: 2px solid limegreen;
            background-color: black;
        }

        .radar-info {
            text-align: center;
            color: #00ff0088;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .back-link {
            text-align: center;
            margin-top: 30px;
            font-size: 1.2em;
        }

        .back-link a {
            color: limegreen;
            text-decoration: none;
            border: 2px solid limegreen;
            padding: 10px 20px;
            display: inline-block;
        }

        .back-link a:hover {
            background-color: limegreen;
            color: black;
        }

        .ascii-art {
            text-align: center;
            font-size: 10px;
            line-height: 1;
            margin: 10px 0;
            opacity: 0.6;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>‚õàÔ∏è NERD WEATHER TERMINAL ‚õàÔ∏è</h1>

        <div class="ascii-art">
            <pre>
    .-.      .-.      .-.      .-.      .-.      .-.      .-.      .-. 
   (   ).   (   ).   (   ).   (   ).   (   ).   (   ).   (   ).   (   )
  (___)_)  (___)_)  (___)_)  (___)_)  (___)_)  (___)_)  (___)_)  (___)_)
</pre>
        </div>

        <div class="form-section">
            <form id="weatherForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>> PLACE</label>
                        <input type="text" id="location" placeholder="Default is KYOSK">
                    </div>
                    <div class="form-group">
                        <label>> LATITUDE</label>
                        <input type="number" id="latitude" step="0.000000000000001" placeholder="47.993794">
                    </div>
                    <div class="form-group">
                        <label>> LONGITUDE</label>
                        <input type="number" id="longitude" step="0.000000000000001" placeholder="7.840820">
                    </div>
                    <div class="form-group">
                        <label>> START DATE (now till 1 month back)</label>
                        <input type="date" id="start_date">
                    </div>
                </div>

                <div class="form-row2">
                    <div class="form-group">
                        <label>> PV POWER kW</label>
                        <input type="text" id="pv_power_kWp" placeholder="Default=1000">
                    </div>
                    <div class="form-group">
                        <label>> WIND POWER kW</label>
                        <input type="text" id="turbine_power_kW" placeholder="Default=1000">
                    </div>
                    <button type="submit" id="runBtn" style="font-size: calc(0.95em + 3px);">[RUN PREDICTION] </button>
                </div>

                <br>
                <hr style="border: 1px solid limegreen; margin: 20px    0;">
                <div class="form-row2">
                    <div class="form-group">
                        <label>> RADAR RADIUS km</label>
                        <input type="number" id="radar_radius" value="50" min="10" max="1000">
                    </div>
                    <button type="button" id="radarBtn" onclick="generateRadar()"
                        style="width:auto; display:inline-block; padding:8px 20px; font-size: calc(0.95em + 3px);">[GENERATE
                        RADAR] (its slow...)</button>
                </div>
            </form>
        </div>

        <div id="loading">>> PROCESSING DATA...</div>
        <div id="error"></div>

        <div id="output"></div>

        <!-- Radar Section -->
        <h2>üì° RADAR PRECIPITATION MAP üì°</h2>
        <div class="radar-section">
            <div id="radar-loading"
                style="display: none; text-align: center; padding: 20px; animation: blink 1s infinite;">
                >> LOADING RADAR MAP... wait 3 min :/
            </div>
            <div id="radar-error"
                style="display: none; background-color: rgba(255, 0, 0, 0.2); color: red; border: 2px solid red; padding: 15px; margin: 20px 0;">
            </div>
            <div id="radar-output" class="radar-output"></div>
            <div class="radar-info">
                >> AUTO-UPDATES EVERY 10 MINUTES
            </div>
        </div>
    </div>

    <div class="back-link">
        <a href="/">[‚Üê BACK TO MAIN]</a>
    </div>

    <script>
        const output = document.getElementById('output');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const form = document.getElementById('weatherForm');
        const runBtn = document.getElementById('runBtn');
        const radarBtn = document.getElementById('radarBtn');
        const radarLoading = document.getElementById('radar-loading');
        const radarError = document.getElementById('radar-error');
        const radarOutput = document.getElementById('radar-output');

        // Load everything when page loads
        window.addEventListener('load', () => {
            loadPlots();
            loadRadarVideo();
        });

        // Handle form submission - only run prediction
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            runPrediction();
        });

        function getFormData() {
            const formData = {};
            const loc = document.getElementById('location').value;
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const date = document.getElementById('start_date').value;
            const pvpower = document.getElementById('pv_power_kWp').value;
            const windpower = document.getElementById('turbine_power_kW').value;
            const radius = document.getElementById('radar_radius').value;

            if (loc) formData.location = loc;
            if (lat) formData.latitude = parseFloat(lat);
            if (lon) formData.longitude = parseFloat(lon);
            if (date) formData.start_date = date;
            if (pvpower) formData.pv_power_kWp = parseInt(pvpower);
            if (windpower) formData.turbine_power_kW = parseInt(windpower);
            if (radius) formData.radar_radius = parseInt(radius);

            return formData;
        }

        async function runPrediction() {
            const formData = getFormData();

            // Disable button
            runBtn.disabled = true;

            try {
                await generatePrediction(formData);
            } finally {
                // Re-enable button
                runBtn.disabled = false;
            }
        }

        async function loadPlots() {
            loading.style.display = 'block';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('initial-plots?t=' + Date.now());

                if (!response.ok) {
                    throw new Error('Could not load plots file');
                }

                let html = await response.text();
                output.innerHTML = html;

                const scripts = output.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.type = 'text/javascript';
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });

            } catch (error) {
                console.error('Load error:', error);
                errorDiv.textContent = '>> ERROR: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadRadarVideo() {
            radarLoading.style.display = 'block';
            radarError.style.display = 'none';

            try {
                // Check if video exists
                const response = await fetch('radar-video?t=' + Date.now(), { method: 'HEAD' });

                if (response.ok) {
                    // Display the existing video
                    radarOutput.innerHTML = `
<video
  controls
  autoplay
  loop
  style="max-width: 100%; border: 2px solid limegreen; filter: invert(100%);"
>
  <source src="radar-video?t=${Date.now()}" type="video/mp4">
  Your browser does not support the video tag.
</video>

<p style="margin-top: 10px; color: limegreen;">
  Last 2 hours of precipitation data
</p>
                    `;
                } else {
                    radarOutput.innerHTML = '<p style="color: #00ff0088;">No radar data available yet. Click [GENERATE RADAR] to create...</p>';
                }

            } catch (error) {
                console.error('Radar load error:', error);
                radarOutput.innerHTML = '<p style="color: #00ff0088;">Radar data loading...</p>';
            } finally {
                radarLoading.style.display = 'none';
            }
        }

        async function generatePrediction(formData) {
            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            output.innerHTML = '';

            try {
                const response = await fetch('predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Prediction failed');
                }

                output.innerHTML = data.html;

                const scripts = output.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.type = 'text/javascript';
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });

            } catch (error) {
                console.error('Error:', error);
                errorDiv.textContent = '>> ERROR: ' + error.message;
                errorDiv.style.display = 'block';
                throw error;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function generateRadar() {
            const formData = getFormData();

            radarLoading.style.display = 'block';
            radarError.style.display = 'none';
            radarBtn.disabled = true;

            try {
                const response = await fetch('radar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Radar generation failed');
                }

                // Reload the video with cache bust
                radarOutput.innerHTML = `
                    <video controls autoplay loop style="max-width: 100%; border: 2px solid limegreen;">
                        <source src="radar-video?t=${Date.now()}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <p style="margin-top: 10px; color: limegreen;">Last 2 hours of precipitation data</p>
                `;

            } catch (error) {
                console.error('Radar error:', error);
                radarError.textContent = '>> RADAR ERROR: ' + error.message;
                radarError.style.display = 'block';
            } finally {
                radarLoading.style.display = 'none';
                radarBtn.disabled = false;
            }
        }

        // Auto-reload radar video every 10 minutes
        setInterval(() => {
            console.log('Auto-reloading radar video...');
            loadRadarVideo();
        }, 10 * 60 * 1000); // 10 minutes
    </script>
</body>

</html>